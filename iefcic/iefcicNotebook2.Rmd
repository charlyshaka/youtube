---
title: "IEFCIC R Notebook 2"
output: html_notebook
---

Éste es un [R Markdown](http://rmarkdown.rstudio.com) Notebook. Cuando ejecutes el código contenido, los resultados aparecerán debajo del código.

Los archivos que se van a usar fueron descargados de [datos.gov.co](http://www.datos.gov.co). Luego fueron extraídos de forma local en formato .txt y .sav.

En el [vídeo](https://www.youtube.com/watch?v=6ULCP7NsITY) se explica paso a paso la obtención de datos, y en [este vídeo](https://www.youtube.com/watch?v=5wCkW6y36DA&t=8s) se muestran algunas ideas de análisis exploratorio básico.

1. Cargando el set de datos (que puede descargar también desde [aquí](https://github.com/oscarvilla/youtube/tree/master/iefcic)) Y revisamos el encabezado solo para estar seguros.
```{r, cache=TRUE}
library(haven)
setwd("./")
df <- read_sav("./IEFIC_2015.sav")
head(df)
```

2. Extrayendo las variables por subgrupos.Así podremos explorarlas para quedarnos en cada caso solamente con las que son de nuestro interés.

```{r, warning=FALSE, cache=TRUE}
dingresos <- df[, c(5:6)]
dinstfinan <- df[, c(12:15)]
delectrodom <- df[, c(43:54)]
dgastoshog <- df[, c(55:68)]
ddistinghog <- df[, c(69:95)]
dmaqyequ <- df[, c(115:118)]
ddeudanohipotecaria <- df[, c(129:179)]
dendeud <- df[, c(203:209)]
dnegocio <- df[, c(210:214)]
dcrednegocio <- df[, c(215:221)]
dcredvehic <- df[, c(224:232)]
dsex <- df[, 233]
dcreditoytarj <- df[, c(234:255)]
```

3. Vamos a enfocarnos en el apartado "F. Deudas no hipotecarias". Tenemos que limpiar el set de datos: convertimos todos los NaN a ceros (0).
```{r, message=FALSE, cache=TRUE}
## Creamos la función que ajusta el formato del set de datos
limpia <- function(x){
        x <- sapply(x, FUN = function(x) {x <- as.numeric(x)})
        x[x == "NaN"] <- 0 ## Convertir todos los NaN a cero
        x[is.na(x)] <- 0
        return(x)
}
dt <- as.data.frame(limpia(ddeudanohipotecaria))
dt <- dt[, -c(2, 9, 18, 25, 32, 39, 47)] ## Columnas de ceros (son realmente encabezados de categorías)
dt <- dt[, -c(42:44)] ## Total de endeudamiento con capital e intereses
```

4. Visualización de los datos: El analisis de los datos puede agilizarse gracias a la visualización de los mismos.
4.1. Primero veamos todas las correlaciones de las variables entre sí, para luego pasar a ver la correlación con la variable dependiente: endeudamiento total.


```{r}
library(qgraph)
qgraph(cor(dt), shape="circle", posCol="darkgreen", negCol="darkred", layout="groups", vsize=8)
```

Todas las correlaciones son positivas: a primera vista parece que las personas mientras más endeudadas, más pagan, más deben y a más cŕeditos recurren a un mayor número de cuotas.

Tenemos:
P2633 con P2548: Los que tienen prestamos con compraventas tienden a tenerlos con los "gota a gota"
P2633 con P2734: Los que tienen prestamos con compraventas tienden a tener creditos educativos.
P2633 con P2695: Los que tiene préstamos con compraventas tienden a tener créditos con Cajas de compensación
P2734 con P2692: Los que tienen crédito educativo tienden a tener "fiado" en la tienda.
P2734 con P2633: Los que tienen crédito educativo tienden a tener "gota a gota".
P2734 con P260: Los que tienen crédito educativo tienden a tener préstamos de libre inversión.
P2734 con P2548: Los que tienen crédito educativo tienden a tener préstamos con compraventas.
```{r}
corr <- as.data.frame(cor(dt)[, length(dt)])
names(corr) <- "coefcorr"
corr
```

Las variables tiene correlaciones fuertes entre sí, pero no con la variable dependiente

4.3. Aventuremos la construcción de un modelo con regresiones lineales
```{r}
model <- lm(P2736_1 ~., data = dt)
summary(model)
```

Entonces intentemos un nuevo modelo con las variables que se mostraron significativas, las marcadas con asteriscos

```{r}
model <- lm(P2736_1 ~ P2548 + P2595 + P2602 + P2623_2 + P2630 + P2695 + P2731, data = dt)
summary(model)
```

Es un modelo que en tanto que modelo está lejos de ser bueno, dado que los datos no tienen una distribución normal. Sin embargo, en tanto que análisis exploratorio nos permite identificar variables sobre las cuales se debe hacer un estudio para verificar su relevancia en el estado total de endeudamiento.

Es así que de 51 variables nos quedamos con 7, por ahora: 
- P2548: ¿tiene cŕeditos con compraventas?
- P2595: ¿sabe en cuántos meses termina de pagar estos créditos con compraventas?
- 2602: ¿tiene otros préstamos bancarios de libre inversión?
- P2623_2: ¿monto de los intereses de los créditos de libre inversión? que son altamente dependientes del capital adeudado, pero también de las tasas de interés.
- P2630: ¿sabe en cuántos meses termina de pagar los préstamos de libre inversión?
- P2695: ¿tiene crédito con cajas de compensación, cooperativas o fondos de empleados?
- P2731:  ¿Sabe en cuántos meses terminará de pagar estos préstamos con fondos de empleados? 


Hya variables que podríamos cambiar por otras, e ir probando cómo se efecta la precisión del modelo. Por ejemplo, la P2633_2 por otras de las de la categoría.

En general, parece que desconocer los plazos y términos o prestarles poca atención es un factor importante que conduce a mayores niveles de endeudamiento o los altos niveles de endeudamiento conducen a que las personas descuiden esos aspectos, por irrealizables, por frustración, por ser algo de lo que prefieren no saber...